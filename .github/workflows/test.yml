name: test matrix


on:
  push:
    branches: '**'


jobs:

  makematrix:
    outputs:
      matrix: ${{steps.setmatrix.outputs.matrix}}
    runs-on: ubuntu-latest  
    steps:
      - id: setmatrix
        name: set outputs.matrix
        run: echo matrix='[{"name":"big", "val":"11"}, {"name":"small"}]' >> $GITHUB_OUTPUT
      - name: value=${{steps.setmatrix.outputs.matrix}}
        run: echo '${{steps.setmatrix.outputs.matrix}}' | jq

  tmatrix:
    name: someName
    needs: makematrix
    strategy:
      matrix:
        include: ${{ fromJson(needs.makematrix.outputs.matrix)}}
          # - { name: big, value: 333 }
          # - { name: small, value: 1234 }
    runs-on: ubuntu-latest
    steps:
      - name: step-${{ matrix.name }}-${{matrix.val}}
        id: exec
        run: |
          dump=`echo '${{toJson(matrix)}}' | jq -c`
          echo "output={\"name\":\"${{matrix.name}}\",\"obj\":$dump}" | tee -a $GITHUB_OUTPUT
    outputs:
      output: ${{steps.exec.outputs.output}}

  summary:
    needs: tmatrix
    if: ${{always()}}
    runs-on: ubuntu-latest
    steps:
      - name: dump
        run: echo 'summary=${{(needs.tmatrix.outputs.output)}}'
